<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Mﾃ｡gico 笨ｨ Pro | Conectado</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');

        :root {
            --bg-color: #e0e5ec;
            --glass: rgba(255, 255, 255, 0.85);
            --primary: #6c5ce7;
            --primary-light: #8579ec;
            --secondary: #00cec9;
            --danger: #ff7675;
            --success: #00b894;
            --text: #2d3436;
            --text-light: #636e72;
            --shadow: 0 20px 40px rgba(31, 38, 135, 0.15);
            --border-radius: 24px;
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }

        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
            display: flex;
            padding: 20px;
            color: var(--text);
            overflow-x: hidden;
        }

        /* --- TELA DE LOGIN/CADASTRO --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.4);
            padding: 40px;
            width: 100%;
            max-width: 480px;
            animation: fadeIn 0.5s ease;
        }

        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-logo { font-size: 2.5rem; margin-bottom: 15px; }
        .auth-title { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .form-label { font-weight: 700; font-size: 0.9rem; }
        .form-input {
            padding: 16px 20px;
            border-radius: 16px;
            border: 2px solid #dfe6e9;
            font-size: 1rem;
            outline: none;
            background: rgba(255,255,255,0.9);
        }
        .form-input:focus { border-color: var(--primary); }

        .auth-btn {
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-weight: 900;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: var(--transition);
        }
        .auth-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3); }

        .auth-switch { text-align: center; margin-top: 25px; color: var(--text-light); }
        .auth-switch a { color: var(--primary); font-weight: 700; cursor: pointer; text-decoration: underline; }

        /* --- Layout Principal --- */
        .app-container {
            display: none;
            grid-template-columns: 80px 1fr;
            width: 100%;
            height: calc(100vh - 40px);
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px;
            background: rgba(255,255,255,0.3);
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .nav-btn {
            width: 56px; height: 56px;
            border-radius: 18px; border: none;
            background: transparent;
            font-size: 1.5rem; margin-bottom: 15px;
            cursor: pointer; color: #b2bec3;
            transition: var(--transition);
        }
        .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 10px 20px -5px rgba(108,92,231,0.4); transform: scale(1.05); }

        .content-area { padding: 30px; overflow-y: auto; background: rgba(255,255,255,0.5); width: 100%; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Componentes do PDV */
        .pdv-header { display: flex; gap: 15px; margin-bottom: 25px; }
        .scan-input { flex: 1; padding: 18px; border-radius: 18px; border: 2px solid var(--primary); font-size: 1.1rem; outline: none; }
        
        .pdv-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; height: calc(100vh - 200px); }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; overflow-y: auto; align-content: start; }
        
        .product-card {
            background: white; border-radius: 20px; padding: 15px; text-align: center;
            cursor: pointer; transition: var(--transition); border: 2px solid transparent;
        }
        .product-card:hover { border-color: var(--secondary); transform: translateY(-5px); }
        .product-emoji { font-size: 3rem; display: block; margin-bottom: 10px; }
        .product-price { color: var(--primary); font-weight: 800; font-size: 1.2rem; }

        .cart-panel { background: white; border-radius: 24px; padding: 20px; display: flex; flex-direction: column; height: 100%; }
        .cart-items { flex: 1; overflow-y: auto; margin: 15px 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed #dfe6e9; }
        
        .btn-checkout {
            background: var(--success); color: white; border: none; padding: 15px;
            border-radius: 15px; font-weight: 900; font-size: 1.2rem; cursor: pointer; width: 100%;
        }

        /* Toast de Notificaﾃｧﾃ｣o */
        .toast {
            position: fixed; bottom: 30px; right: 30px;
            background: #2d3436; color: white; padding: 15px 25px;
            border-radius: 12px; transform: translateX(200%); transition: transform 0.3s;
            z-index: 9999; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(0); }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }

        /* Loader */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #dfe6e9;
            border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Status Connection */
        .db-status {
            position: absolute; top: 10px; right: 10px;
            padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
        }
        .status-ok { background: #00b894; color: white; }
        .status-err { background: #ff7675; color: white; }

        /* Mobile */
        @media(max-width: 800px) {
            .pdv-grid { grid-template-columns: 1fr; }
            .app-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { flex-direction: row; padding: 10px; justify-content: center; }
            .nav-btn { margin: 0 10px; }
        }
    </style>
</head>
<body>

    <div id="dbStatus" class="db-status status-err" style="display: none;">Verificando conexﾃ｣o...</div>

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: var(--primary);">Processando...</p>
    </div>

    <div id="toast" class="toast">Mensagem aqui</div>

    <div class="auth-container" id="authContainer">
        
        <div class="auth-card" id="loginCard">
            <div class="auth-header">
                <div class="auth-logo">笨ｨ</div>
                <h1 class="auth-title">PDV Mﾃ｡gico</h1>
                <p>Login do Sistema</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-btn">Entrar</button>
            </form>
            <div class="auth-switch">
                Novo aqui? <a onclick="toggleAuth('register')">Criar conta</a>
            </div>
        </div>

        <div class="auth-card" id="registerCard" style="display: none;">
            <div class="auth-header">
                <div class="auth-logo">噫</div>
                <h1 class="auth-title">Criar Conta</h1>
                <p>Comece grﾃ｡tis agora</p>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">Nome da Empresa</label>
                    <input type="text" class="form-input" id="regCompany" placeholder="Ex: Padaria da Maria" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="regPassword" required>
                </div>
                <button type="submit" class="auth-btn">Cadastrar</button>
            </form>
            <div class="auth-switch">
                Jﾃ｡ tem conta? <a onclick="toggleAuth('login')">Fazer Login</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <nav class="sidebar">
            <button class="nav-btn active" onclick="showTab('pdv')"><i class="fas fa-cash-register"></i></button>
            <button class="nav-btn" onclick="showTab('stock')"><i class="fas fa-boxes"></i></button>
            <button class="nav-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </nav>

        <main class="content-area">
            <section id="pdv" class="section active">
                <div class="pdv-header">
                    <input type="text" id="searchInput" class="scan-input" placeholder="剥 Buscar produto ou cﾃｳdigo de barras..." autofocus>
                </div>
                <div class="pdv-grid">
                    <div class="product-list" id="productsGrid">
                        </div>
                    <div class="cart-panel">
                        <h3 style="margin-bottom: 15px;">Carrinho (<span id="cartCount">0</span>)</h3>
                        <div class="cart-items" id="cartItems">
                            <p style="text-align: center; color: #999; margin-top: 20px;">Carrinho vazio</p>
                        </div>
                        <div style="margin-top: auto;">
                            <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 15px;">
                                <span>Total:</span>
                                <span id="cartTotal">R$ 0,00</span>
                            </div>
                            <button class="btn-checkout" onclick="finalizeSale()">Finalizar Venda</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="stock" class="section">
                <h2>Gerenciar Estoque</h2>
                <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 20px;">
                    <div class="form-group">
                        <input type="text" id="newProdName" class="form-input" placeholder="Nome do Produto">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="newProdPrice" class="form-input" placeholder="Preﾃｧo" style="width: 50%;">
                        <input type="number" id="newProdStock" class="form-input" placeholder="Qtd" style="width: 50%;">
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                         <input type="text" id="newProdEmoji" class="form-input" placeholder="Emoji (ex: 鵠)">
                    </div>
                    <button class="auth-btn" onclick="addProduct()">Adicionar Produto</button>
                </div>
                <div id="stockList" style="margin-top: 20px;"></div>
            </section>
        </main>
    </div>

<script>
    // --- CONFIGURAﾃﾃグ SUPABASE ---
    const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';

    let supabase;
    let currentUser = null;
    let products = [];
    let cart = [];

    // --- INICIALIZAﾃﾃグ ---
    window.onload = async function() {
        if (typeof window.supabase === 'undefined') {
            alert('Erro: Biblioteca Supabase nﾃ｣o carregou. Verifique sua internet.');
            return;
        }

        const { createClient } = window.supabase;
        supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Teste de conexﾃ｣o
        checkConnection();

        // Verificar sessﾃ｣o local
        const savedUser = localStorage.getItem('pdv_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        }
    };

    async function checkConnection() {
        const statusEl = document.getElementById('dbStatus');
        statusEl.style.display = 'block';
        try {
            // Tenta buscar algo simples sﾃｳ para testar a conexﾃ｣o
            const { data, error } = await supabase.from('users').select('count', { count: 'exact', head: true });
            
            if (error) {
                if (error.code === '42P01') {
                    statusEl.className = 'db-status status-err';
                    statusEl.innerText = 'ERRO: Tabelas nﾃ｣o criadas no Supabase!';
                    alert('ATENﾃﾃグ: Vocﾃｪ precisa rodar o cﾃｳdigo SQL no painel do Supabase para criar as tabelas (users, products, sales). Sem isso, nada funcionarﾃ｡.');
                } else {
                    throw error;
                }
            } else {
                statusEl.className = 'db-status status-ok';
                statusEl.innerText = 'Supabase Conectado 笨';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            }
        } catch (e) {
            console.error(e);
            statusEl.className = 'db-status status-err';
            statusEl.innerText = 'Erro de Conexﾃ｣o';
        }
    }

    // --- AUTENTICAﾃﾃグ ---
    function toggleAuth(screen) {
        document.getElementById('loginCard').style.display = screen === 'login' ? 'block' : 'none';
        document.getElementById('registerCard').style.display = screen === 'register' ? 'block' : 'none';
    }

    // Registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader(true);
        
        const company = document.getElementById('regCompany').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value; // Em produﾃｧﾃ｣o, use hash!

        // Verificar se email existe
        const { data: exists } = await supabase.from('users').select('id').eq('email', email);
        if (exists && exists.length > 0) {
            showLoader(false);
            showToast('Email jﾃ｡ cadastrado!', 'error');
            return;
        }

        // Criar usuﾃ｡rio na tabela users
        const { data, error } = await supabase.from('users').insert([
            { company_name: company, email: email, password_hash: password }
        ]).select().single();

        showLoader(false);
        if (error) {
            console.error(error);
            if(error.code === '42P01') {
                alert('ERRO CRﾃ控ICO: Tabela "users" nﾃ｣o existe. Rode o SQL no Supabase.');
            }
            showToast('Erro ao cadastrar: ' + error.message, 'error');
        } else {
            currentUser = data;
            localStorage.setItem('pdv_user', JSON.stringify(data));
            showToast('Conta criada com sucesso!', 'success');
            showApp();
        }
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader(true);

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('password_hash', password)
            .single();

        showLoader(false);
        if (error || !data) {
            showToast('Email ou senha invﾃ｡lidos', 'error');
        } else {
            currentUser = data;
            localStorage.setItem('pdv_user', JSON.stringify(data));
            showApp();
        }
    });

    function logout() {
        localStorage.removeItem('pdv_user');
        location.reload();
    }

    // --- APLICAﾃﾃグ ---
    function showApp() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'grid';
        loadProducts();
    }

    function showTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        if(tabId === 'pdv') loadProducts(); // Recarrega ao voltar pro PDV
    }

    // --- PRODUTOS ---
    async function loadProducts() {
        if (!currentUser) return;
        
        const { data, error } = await supabase
            .from('products')
            .select('*')
            .eq('user_id', currentUser.id);

        if (data) {
            products = data;
            renderProducts(products);
            renderStockList(products);
        }
    }

    async function addProduct() {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const stock = document.getElementById('newProdStock').value;
        const emoji = document.getElementById('newProdEmoji').value || '逃';

        if (!name || !price) return showToast('Preencha nome e preﾃｧo', 'error');

        showLoader(true);
        const { error } = await supabase.from('products').insert([{
            user_id: currentUser.id,
            name: name,
            price: price,
            stock: stock || 0,
            emoji: emoji
        }]);

        showLoader(false);
        if (error) {
            showToast('Erro ao salvar', 'error');
        } else {
            showToast('Produto adicionado!', 'success');
            // Limpar campos
            document.getElementById('newProdName').value = '';
            document.getElementById('newProdPrice').value = '';
            loadProducts();
        }
    }

    function renderProducts(list) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';
        list.forEach(p => {
            const div = document.createElement('div');
            div.className = 'product-card';
            div.innerHTML = `
                <span class="product-emoji">${p.emoji}</span>
                <div style="font-weight:bold;">${p.name}</div>
                <div class="product-price">R$ ${parseFloat(p.price).toFixed(2)}</div>
            `;
            div.onclick = () => addToCart(p);
            grid.appendChild(div);
        });
    }

    function renderStockList(list) {
        const container = document.getElementById('stockList');
        container.innerHTML = list.map(p => 
            `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:10px; display:flex; justify-content:space-between;">
                <span>${p.emoji} ${p.name}</span>
                <strong>Estoque: ${p.stock}</strong>
            </div>`
        ).join('');
    }

    // --- CARRINHO ---
    function addToCart(product) {
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
            existing.qty++;
        } else {
            cart.push({ ...product, qty: 1 });
        }
        updateCartUI();
    }

    function updateCartUI() {
        const container = document.getElementById('cartItems');
        const countEl = document.getElementById('cartCount');
        const totalEl = document.getElementById('cartTotal');
        
        container.innerHTML = '';
        let total = 0;
        let count = 0;

        cart.forEach(item => {
            total += item.price * item.qty;
            count += item.qty;
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <div>
                    <div>${item.name}</div>
                    <small>R$ ${item.price} x ${item.qty}</small>
                </div>
                <strong>R$ ${(item.price * item.qty).toFixed(2)}</strong>
            `;
            container.appendChild(div);
        });

        if (cart.length === 0) container.innerHTML = '<p style="text-align: center; color: #999; margin-top: 20px;">Carrinho vazio</p>';
        
        countEl.innerText = count;
        totalEl.innerText = `R$ ${total.toFixed(2)}`;
    }

    async function finalizeSale() {
        if (cart.length === 0) return showToast('Carrinho vazio!', 'error');

        showLoader(true);
        const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);

        // Registrar venda
        const { error } = await supabase.from('sales').insert([{
            id: 'VENDA-' + Date.now(),
            user_id: currentUser.id,
            total: total,
            items_count: cart.length,
            sale_date: new Date().toISOString()
        }]);

        if (error) {
            showLoader(false);
            return showToast('Erro ao finalizar venda', 'error');
        }

        // Atualizar estoque (Simplificado)
        for (let item of cart) {
            const newStock = item.stock - item.qty;
            await supabase.from('products').update({ stock: newStock }).eq('id', item.id);
        }

        showLoader(false);
        showToast('Venda realizada com sucesso! 脂', 'success');
        cart = [];
        updateCartUI();
        loadProducts();
    }

    // --- UTILITﾃヽIOS ---
    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = `toast show ${type}`;
        setTimeout(() => t.className = 'toast', 3000);
    }
</script>
</body>
</html>
