<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV MÃ¡gico âœ¨ Pro | Conectado Supabase</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #e0e5ec;
            --glass: rgba(255, 255, 255, 0.9);
            --primary: #6c5ce7;
            --primary-dark: #5649c0;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --text: #2d3436;
            --danger: #ff7675;
            --success: #00b894;
            --warning: #fdcb6e;
            --shadow: 9px 9px 16px rgb(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
            --inner-shadow: inset 6px 6px 10px 0 rgba(163,177,198, 0.7), inset -6px -6px 10px 0 rgba(255,255,255, 0.8);
        }

        body.dark-mode {
            --bg-color: #2d3436;
            --glass: rgba(45, 52, 54, 0.95);
            --text: #dfe6e9;
            --shadow: 5px 5px 10px rgba(0,0,0,0.5), -5px -5px 10px rgba(255,255,255,0.05);
            --inner-shadow: inset 5px 5px 10px rgba(0,0,0,0.5), inset -5px -5px 10px rgba(255,255,255,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--bg-color); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 80px;
            background: var(--glass);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            border: none;
            background: var(--bg-color);
            color: var(--text);
            font-size: 1.2rem;
            margin-bottom: 20px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn.active, .nav-btn:hover {
            color: var(--primary);
            box-shadow: var(--inner-shadow);
            transform: scale(0.95);
        }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: var(--glass);
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--bg-color);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--inner-shadow);
            width: 60%;
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            margin-left: 10px;
            color: var(--text);
            font-size: 1rem;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            padding-bottom: 80px;
        }

        .product-card {
            background: var(--glass);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            position: relative;
            border: 2px solid transparent;
        }

        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        .product-emoji { font-size: 3rem; display: block; margin-bottom: 10px; }
        .product-name { font-weight: 700; margin-bottom: 5px; line-height: 1.2; }
        .product-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .product-stock { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 0.75rem; padding: 2px 6px; border-radius: 8px;
            color: #fff;
        }
        .stock-high { background: var(--success); }
        .stock-medium { background: var(--warning); color: #333; }
        .stock-low { background: var(--danger); }

        /* Cart/Panel Direita */
        .cart-panel {
            width: 350px;
            background: var(--glass);
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .cart-items { flex: 1; overflow-y: auto; margin: 20px 0; }
        
        .cart-item {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .qty-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn {
            width: 25px; height: 25px; border-radius: 50%; border: none;
            background: var(--bg-color); box-shadow: var(--shadow);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .qty-btn:active { box-shadow: var(--inner-shadow); }

        .total-section {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            margin-top: auto;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
        }
        
        .checkout-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 12px;
            background: #fff;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* Forms & Tables */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-control {
            width: 100%; padding: 10px 15px; border-radius: 10px;
            border: none; background: var(--bg-color); box-shadow: var(--inner-shadow);
            color: var(--text); outline: none;
        }

        table { width: 100%; border-collapse: collapse; background: var(--glass); border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        th { background: rgba(0,0,0,0.02); font-weight: 700; color: var(--primary); }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--glass-dark); padding: 30px; border-radius: 25px;
            width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            background-color: #fff;
        }

        /* Status ConexÃ£o */
        .connection-badge {
            position: absolute; bottom: 10px; right: 10px;
            padding: 5px 10px; border-radius: 20px; font-size: 0.8rem;
            display: flex; align-items: center; gap: 5px;
            background: var(--bg-color); box-shadow: var(--inner-shadow);
        }
        .online { color: var(--success); }
        .offline { color: var(--danger); }

        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 2000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--bg-color);
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: var(--primary);">Sincronizando com Nuvem...</p>
    </div>

    <div class="sidebar">
        <button class="nav-btn active" onclick="switchTab('pdv')" title="Caixa"><i class="fas fa-cash-register"></i></button>
        <button class="nav-btn" onclick="switchTab('stock')" title="Estoque"><i class="fas fa-boxes"></i></button>
        <button class="nav-btn" onclick="switchTab('history')" title="Vendas"><i class="fas fa-history"></i></button>
        <button class="nav-btn" onclick="toggleDarkMode()" title="Tema"><i class="fas fa-moon"></i></button>
    </div>

    <div class="main-content">
        
        <div id="pdv" class="section active">
            <header>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar produto ou cÃ³digo de barras..." onkeyup="filterProducts()">
                </div>
                <div style="font-weight: bold; color: var(--primary);">
                    <i class="fas fa-store"></i> PDV MÃ¡gico Pro
                </div>
            </header>

            <div class="products-grid" id="productsGrid">
                </div>
        </div>

        <div id="stock" class="section">
            <header>
                <h1>GestÃ£o de Estoque</h1>
                <button class="nav-btn" style="width: auto; padding: 0 20px; font-size: 1rem;" onclick="openModal('modalProduct')">
                    <i class="fas fa-plus"></i> Novo Produto
                </button>
            </header>
            
            <div style="overflow-x: auto;">
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>PreÃ§o</th>
                            <th>Estoque</th>
                            <th>Categoria</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="history" class="section">
            <header>
                <h1>HistÃ³rico de Vendas</h1>
                <div id="dashboardStats" style="display: flex; gap: 15px;">
                    <span style="padding: 10px; background: var(--success); color: white; border-radius: 10px;">
                        Total Hoje: <b id="dashTotalToday">R$ 0,00</b>
                    </span>
                </div>
            </header>
            <table id="salesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>MÃ©todo</th>
                        <th>Total</th>
                        <th>Itens</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody"></tbody>
            </table>
        </div>
        
        <div id="connectionStatus" class="connection-badge online">
            <i class="fas fa-wifi"></i> Conectado
        </div>
    </div>

    <div class="cart-panel">
        <h2><i class="fas fa-shopping-cart"></i> Carrinho</h2>
        <div class="cart-items" id="cartItems">
            <div style="text-align: center; color: #999; margin-top: 50px;">
                Carrinho vazio
            </div>
        </div>

        <div class="total-section">
            <div style="font-size: 0.9rem; opacity: 0.8;">Total a Pagar</div>
            <div style="font-size: 2.5rem; font-weight: 800;" id="cartTotal">R$ 0,00</div>
            <button class="checkout-btn" id="btnCheckout" onclick="openPaymentModal()" disabled>
                Finalizar Venda <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="modalPayment" class="modal">
        <div class="modal-content">
            <h2>Forma de Pagamento</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
                <button class="nav-btn" style="width: 100%; border-radius: 10px;" onclick="finalizeSale('Dinheiro')">ðŸ’µ Dinheiro</button>
                <button class="nav-btn" style="width: 100%; border-radius: 10px;" onclick="finalizeSale('Pix')">ðŸ’  Pix</button>
                <button class="nav-btn" style="width: 100%; border-radius: 10px;" onclick="finalizeSale('CrÃ©dito')">ðŸ’³ CrÃ©dito</button>
                <button class="nav-btn" style="width: 100%; border-radius: 10px;" onclick="finalizeSale('DÃ©bito')">ðŸ’³ DÃ©bito</button>
            </div>
            <button class="checkout-btn" style="background: var(--danger); color: white;" onclick="closeModal('modalPayment')">Cancelar</button>
        </div>
    </div>

    <div id="modalProduct" class="modal">
        <div class="modal-content">
            <h2>Novo Produto</h2>
            <form id="formProduct" onsubmit="event.preventDefault(); saveProduct();">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="prodName" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>PreÃ§o (R$)</label>
                        <input type="number" step="0.01" id="prodPrice" class="form-control" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Estoque</label>
                        <input type="number" id="prodStock" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>CÃ³digo de Barras</label>
                    <input type="text" id="prodBarcode" class="form-control">
                </div>
                <div class="form-group">
                    <label>Emoji (Visual)</label>
                    <input type="text" id="prodEmoji" class="form-control" value="ðŸ“¦" placeholder="Ex: ðŸ”, ðŸ‘•">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="checkout-btn" style="background: var(--success); color: white;">Salvar</button>
                    <button type="button" class="checkout-btn" style="background: var(--danger); color: white;" onclick="closeModal('modalProduct')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalReceipt" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 3rem; color: var(--success); margin-bottom: 10px;"><i class="fas fa-check-circle"></i></div>
            <h2>Venda Realizada!</h2>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 10px 0;" id="receiptValue">R$ 0,00</p>
            <p id="receiptDate" style="color: gray;"></p>
            <button class="checkout-btn" onclick="closeModal('modalReceipt')">Nova Venda</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÃ‡ÃƒO SUPABASE ---
        const PROJECT_URL = 'https://kbucnveojexlxlnefmdo.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_NpxLW4j6N0gqFmwC5D4dXQ_ohJ4Rv-n'; 
        const supabase = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // --- 2. ESTADO GLOBAL ---
        let products = [];
        let cart = [];
        let sales = [];

        // --- 3. INICIALIZAÃ‡ÃƒO ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initBarcodeScanner();
        });

        async function loadData() {
            showLoader(true);
            try {
                // Carregar Produtos
                let { data: prodData, error: prodError } = await supabase
                    .from('products')
                    .select('*')
                    .order('name');
                
                if (prodError) throw prodError;
                products = prodData || [];

                // Carregar Vendas (Ãºltimas 50 para nÃ£o pesar)
                let { data: saleData, error: saleError } = await supabase
                    .from('sales')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(50);

                if (saleError) throw saleError;
                sales = saleData || [];

                refreshUI();
                setStatus(true);
            } catch (error) {
                console.error("Erro critico:", error);
                alert("Erro ao conectar com o banco de dados. Verifique a internet.");
                setStatus(false);
            } finally {
                showLoader(false);
            }
        }

        function refreshUI() {
            renderProducts(products);
            renderStockTable();
            renderSalesHistory();
            updateDashboard();
        }

        // --- 4. FUNÃ‡Ã•ES DE PRODUTOS ---
        
        async function saveProduct() {
            const name = document.getElementById('prodName').value;
            const price = parseFloat(document.getElementById('prodPrice').value);
            const stock = parseInt(document.getElementById('prodStock').value);
            const barcode = document.getElementById('prodBarcode').value;
            const emoji = document.getElementById('prodEmoji').value || 'ðŸ“¦';

            if(!name || isNaN(price)) return alert("Preencha corretamente.");

            showLoader(true);
            try {
                const { data, error } = await supabase
                    .from('products')
                    .insert([{ name, price, stock, barcode, emoji, category: 'Geral' }])
                    .select();

                if (error) throw error;

                products.push(data[0]);
                refreshUI();
                closeModal('modalProduct');
                document.getElementById('formProduct').reset();
            } catch (e) {
                alert("Erro ao salvar: " + e.message);
            } finally {
                showLoader(false);
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Excluir produto?")) return;
            
            showLoader(true);
            try {
                const { error } = await supabase.from('products').delete().eq('id', id);
                if(error) throw error;
                
                products = products.filter(p => p.id !== id);
                refreshUI();
            } catch(e) {
                alert("Erro ao excluir");
            } finally {
                showLoader(false);
            }
        }

        async function updateStockDb(id, newStock) {
            try {
                await supabase.from('products').update({ stock: newStock }).eq('id', id);
            } catch (e) {
                console.error("Falha ao sincronizar estoque", e);
            }
        }

        // --- 5. FUNÃ‡Ã•ES DE VENDAS E CARRINHO ---

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (product.stock <= 0) return alert("Produto sem estoque!");

            const existing = cart.find(item => item.id === productId);
            
            if (existing) {
                if(existing.qty >= product.stock) return alert("Estoque limite atingido!");
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            const btn = document.getElementById('btnCheckout');
            
            container.innerHTML = '';
            let total = 0;

            if(cart.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">Carrinho vazio ðŸ›’</div>';
                btn.disabled = true;
                totalEl.innerText = "R$ 0,00";
                return;
            }

            cart.forEach((item, index) => {
                total += item.price * item.qty;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>R$ ${item.price.toFixed(2)} un</small>
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                        <button class="qty-btn" style="color: var(--danger)" onclick="removeCartItem(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });

            totalEl.innerText = `R$ ${total.toFixed(2)}`;
            btn.disabled = false;
        }

        function updateQty(index, change) {
            const item = cart[index];
            const product = products.find(p => p.id === item.id);
            
            const newQty = item.qty + change;
            
            if (newQty > product.stock) return alert("Estoque insuficiente.");
            if (newQty <= 0) return removeCartItem(index);

            item.qty = newQty;
            renderCart();
        }

        function removeCartItem(index) {
            cart.splice(index, 1);
            renderCart();
        }

        async function finalizeSale(method) {
            if(cart.length === 0) return;
            
            closeModal('modalPayment');
            showLoader(true);

            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
            try {
                // 1. Criar registro da venda
                const salePayload = {
                    total: total,
                    payment_method: method,
                    items: cart,
                    date: new Date().toISOString()
                };

                const { data: saleData, error: saleError } = await supabase
                    .from('sales')
                    .insert([salePayload])
                    .select();

                if(saleError) throw saleError;

                // 2. Atualizar Estoque (Loop)
                for (const item of cart) {
                    const product = products.find(p => p.id === item.id);
                    if(product) {
                        const newStock = product.stock - item.qty;
                        // Atualiza banco
                        await updateStockDb(product.id, newStock);
                        // Atualiza local
                        product.stock = newStock;
                    }
                }

                // Sucesso
                sales.unshift(saleData[0]);
                cart = []; // Limpa carrinho
                
                refreshUI();
                renderCart();
                
                // Mostrar recibo
                document.getElementById('receiptValue').innerText = `R$ ${total.toFixed(2)}`;
                document.getElementById('receiptDate').innerText = new Date().toLocaleString();
                openModal('modalReceipt');

            } catch (e) {
                console.error(e);
                alert("Erro ao processar venda. Verifique conexÃ£o.");
            } finally {
                showLoader(false);
            }
        }

        // --- 6. RENDERIZAÃ‡ÃƒO E UTILS ---

        function renderProducts(list) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            list.forEach(p => {
                let stockClass = p.stock <= 5 ? 'stock-low' : (p.stock <= 15 ? 'stock-medium' : 'stock-high');
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => addToCart(p.id);
                card.innerHTML = `
                    <span class="product-stock ${stockClass}">${p.stock}</span>
                    <span class="product-emoji">${p.emoji}</span>
                    <div class="product-name">${p.name}</div>
                    <div class="product-price">R$ ${p.price.toFixed(2)}</div>
                `;
                grid.appendChild(card);
            });
        }

        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.emoji} ${p.name}</td>
                    <td>R$ ${p.price.toFixed(2)}</td>
                    <td>${p.stock}</td>
                    <td>${p.category || '-'}</td>
                    <td><button class="qty-btn" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSalesHistory() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            sales.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${s.id}</td>
                    <td>${new Date(s.date).toLocaleDateString()}</td>
                    <td>${s.payment_method}</td>
                    <td style="color: var(--success); font-weight: bold">R$ ${s.total.toFixed(2)}</td>
                    <td>${s.items ? s.items.length + ' itens' : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterProducts() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) || 
                (p.barcode && p.barcode.includes(term))
            );
            renderProducts(filtered);
        }

        function updateDashboard() {
            // Soma vendas de hoje
            const today = new Date().toLocaleDateString();
            const totalToday = sales
                .filter(s => new Date(s.date).toLocaleDateString() === today)
                .reduce((acc, s) => acc + s.total, 0);
            
            const el = document.getElementById('dashTotalToday');
            if(el) el.innerText = `R$ ${totalToday.toFixed(2)}`;
        }

        // UI Helpers
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            // LÃ³gica simples para ativar o botÃ£o correto
            const index = ['pdv', 'stock', 'history'].indexOf(tabId);
            if(index >= 0) document.querySelectorAll('.sidebar .nav-btn')[index].classList.add('active');
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openPaymentModal() { if(cart.length > 0) openModal('modalPayment'); }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function setStatus(online) {
            const el = document.getElementById('connectionStatus');
            el.className = `connection-badge ${online ? 'online' : 'offline'}`;
            el.innerHTML = online ? '<i class="fas fa-wifi"></i> Online (Supabase)' : '<i class="fas fa-wifi-slash"></i> Offline';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function initBarcodeScanner() {
            let buffer = '';
            let lastKeyTime = Date.now();
            
            document.addEventListener('keydown', (e) => {
                // Se estiver digitando em um input, ignora
                if (e.target.tagName === 'INPUT') return;

                const char = e.key;
                const currentTime = Date.now();

                if (currentTime - lastKeyTime > 100) buffer = '';
                lastKeyTime = currentTime;

                if (char === 'Enter') {
                    if (buffer.length > 2) {
                        const product = products.find(p => p.barcode === buffer);
                        if (product) {
                            addToCart(product.id);
                            alert(`Bip! ${product.name} adicionado.`);
                        }
                    }
                    buffer = '';
                } else if (char.length === 1) {
                    buffer += char;
                }
            });
        }
        
    </script>
</body>
</html>
