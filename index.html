<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV M√°gico ‚ú® Pro | Sistema Inteligente</title>
    <style> 
        /* ... (todos os estilos CSS permanecem exatamente iguais) ... */
    </style>
</head>
<body>

<!-- ... (todo o HTML permanece exatamente igual) ... -->

<!-- Incluir Nhost SDK em vez do Supabase -->
<script src="https://unpkg.com/@nhost/nhost-js/dist/nhost.js"></script>

<script>
    // ============================================
    // SISTEMA PDV M√ÅGICO PRO - COM NHOST (VERS√ÉO ATUALIZADA)
    // ============================================

    // --- CONFIGURA√á√ÉO DO NHOST ---
    const NHOST_SUBDOMAIN = 'zywyxusjrpylxofrtshp';
    const NHOST_REGION = 'sa-east-1';
    
    // Configurar cliente Nhost
    let nhost;
    try {
        nhost = new Nhost.NhostClient({
            subdomain: NHOST_SUBDOMAIN,
            region: NHOST_REGION
        });
        console.log('Nhost inicializado com sucesso');
    } catch (error) {
        console.error('Erro ao inicializar Nhost:', error);
    }

    // --- CONFIGURA√á√ÉO INICIAL ---
    const APP_NAME = "PDV M√°gico Pro";
    const APP_VERSION = "2.4.0"; // Vers√£o com Nhost
    const APP_AUTHOR = "Sistema Inteligente";
    const MONTHLY_PRICE = 29.90;
    const TRIAL_DAYS = 7;
    
    // --- SISTEMA DE AUTENTICA√á√ÉO ---
    let currentUser = null;
    let isAuthenticated = false;
    
    // --- BANCO DE EMOJIS AVAN√áADO ---
    const emojiDB = [
        { char: 'üçî', keys: 'hamburguer burger lanche fast food comida', category: 'alimento' },
        { char: 'üçï', keys: 'pizza comida massa italiana queijo', category: 'alimento' },
        { char: 'üå≠', keys: 'hotdog cachorro quente salsicha lanche', category: 'alimento' },
        { char: 'üçü', keys: 'batata frita chips salgado fast', category: 'alimento' },
        { char: 'ü•™', keys: 'sanduiche misto natural lanche', category: 'alimento' },
        { char: 'üåÆ', keys: 'taco mexicano comida', category: 'alimento' },
        { char: 'üçô', keys: 'sushi onigiri arroz japao japones', category: 'alimento' },
        { char: 'üç£', keys: 'sushi peixe cru japao', category: 'alimento' },
        { char: 'üç§', keys: 'camarao frito empanado mar', category: 'alimento' },
        { char: 'üç¶', keys: 'sorvete casquinha doce gelado', category: 'alimento' },
        { char: 'üç©', keys: 'donut rosquinha doce padaria', category: 'alimento' },
        { char: 'üç™', keys: 'cookie biscoito bolacha doce', category: 'alimento' },
        { char: 'üç´', keys: 'chocolate barra doce cacau', category: 'alimento' },
        { char: 'üç¨', keys: 'bala doce caramelo', category: 'alimento' },
        { char: 'üç≠', keys: 'pirulito doce', category: 'alimento' },
        { char: 'üçÆ', keys: 'pudim flan sobremesa', category: 'alimento' },
        { char: '‚òï', keys: 'cafe coffee expresso bebida quente', category: 'bebida' },
        { char: 'ü•§', keys: 'suco refrigerante bebida copo', category: 'bebida' },
        { char: 'üç∫', keys: 'cerveja beer alcool bebida', category: 'bebida' },
        { char: 'üç∑', keys: 'vinho taca bebida alcool', category: 'bebida' },
        { char: 'üç∏', keys: 'drink coquetel alcool', category: 'bebida' },
        { char: 'üçé', keys: 'maca fruta saudavel vermelha', category: 'alimento' },
        { char: 'üçå', keys: 'banana fruta amarela', category: 'alimento' },
        { char: 'üçá', keys: 'uva fruta roxo vinho', category: 'alimento' },
        { char: 'ü••', keys: 'coco fruta tropical', category: 'alimento' },
        { char: 'üçâ', keys: 'melancia fruta verao', category: 'alimento' },
        { char: 'üçí', keys: 'cereja fruta bolo', category: 'alimento' },
        { char: 'üçì', keys: 'morango fruta vermelho doce', category: 'alimento' },
        { char: 'ü•©', keys: 'carne bife churrasco proteina', category: 'alimento' },
        { char: 'üçó', keys: 'frango coxa assado carne', category: 'alimento' },
        { char: 'ü•ì', keys: 'bacon carne porco cafe', category: 'alimento' },
        { char: 'üëï', keys: 'camisa roupa vestuario moda', category: 'vestuario' },
        { char: 'üëñ', keys: 'calca jeans roupa moda', category: 'vestuario' },
        { char: 'üëó', keys: 'vestido roupa mulher', category: 'vestuario' },
        { char: 'üëü', keys: 'tenis sapato calcado esporte', category: 'vestuario' },
        { char: '‚åö', keys: 'relogio watch tempo acessorio', category: 'eletronico' },
        { char: 'üíª', keys: 'notebook laptop computador pc', category: 'eletronico' },
        { char: 'üì±', keys: 'celular iphone smartphone', category: 'eletronico' },
        { char: 'üîå', keys: 'tomada cabo energia', category: 'eletronico' },
        { char: 'üîã', keys: 'bateria pilha energia', category: 'eletronico' },
        { char: 'üéÅ', keys: 'presente caixa surpresa', category: 'outro' },
        { char: 'üì¶', keys: 'caixa pacote encomenda', category: 'outro' },
        { char: 'üíä', keys: 'remedio pilula farmacia saude', category: 'outro' },
        { char: 'üßπ', keys: 'vassoura limpeza casa', category: 'limpeza' },
        { char: 'üõí', keys: 'carrinho compras mercado', category: 'outro' },
        { char: 'üß¥', keys: 'sabonete shampoo higiene', category: 'limpeza' },
        { char: 'üßº', keys: 'sabao detergente limpeza', category: 'limpeza' },
        { char: 'üì∫', keys: 'televisao tv entretenimento', category: 'eletronico' },
        { char: 'üéÆ', keys: 'videogame jogo console', category: 'eletronico' },
        { char: 'üìö', keys: 'livro leitura estudo', category: 'outro' },
        { char: '‚úèÔ∏è', keys: 'lapis caneta escrita', category: 'outro' }
    ];

    // --- ESTADO DO SISTEMA ---
    const defaultProducts = [
        { id: 1, name: 'Hamb√∫rguer M√°gico', price: 25.00, stock: 20, emoji: 'üçî', category: 'alimento' },
        { id: 2, name: 'Po√ß√£o de Cafe√≠na', price: 8.50, stock: 50, emoji: '‚òï', category: 'bebida' },
        { id: 3, name: 'Donut Estelar', price: 12.00, stock: 15, emoji: 'üç©', category: 'alimento' },
        { id: 4, name: 'Pizza Infinita', price: 45.00, stock: 8, emoji: 'üçï', category: 'alimento' },
        { id: 5, name: 'Sushi Zen', price: 60.00, stock: 10, emoji: 'üç£', category: 'alimento' },
        { id: 6, name: 'Sorvete Nuvem', price: 15.00, stock: 25, emoji: 'üç¶', category: 'alimento' },
        { id: 7, name: 'Pipoca Dourada', price: 10.00, stock: 30, emoji: 'üçø', category: 'alimento' },
        { id: 8, name: 'Suco Vitamina', price: 12.00, stock: 40, emoji: 'ü•§', category: 'bebida' },
        { id: 9, name: 'Camisa M√°gica', price: 89.90, stock: 12, emoji: 'üëï', category: 'vestuario' },
        { id: 10, name: 'Fones Celestial', price: 120.00, stock: 5, emoji: 'üéß', category: 'eletronico' },
    ];

    // Estado da aplica√ß√£o
    let products = [...defaultProducts];
    let salesHistory = [];
    let cart = [];
    let currentSaleData = null;
    let currentDiscount = 0;
    let saleStartTime = null;
    
    // Contadores para estat√≠sticas
    let stats = {
        totalSales: 0,
        todaySales: 0,
        weekSales: 0,
        monthSales: 0,
        lowStockItems: 0,
        processingTime: 0
    };

    // --- FUN√á√ïES NHOST CORRIGIDAS ---

    // Fun√ß√£o de hash simples para demonstra√ß√£o
    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
    }

    async function nhostLogin(email, password) {
        showLoader();
        
        try {
            if (!nhost) {
                throw new Error('Nhost n√£o inicializado');
            }

            console.log('Tentando login no Nhost para:', email);
            
            // Tentar autentica√ß√£o no Nhost
            const { session, error } = await nhost.auth.signIn({
                email,
                password
            });
            
            if (error) {
                console.error('Erro no login Nhost:', error);
                hideLoader();
                
                // Se for erro de usu√°rio n√£o encontrado, tentar cadastrar
                if (error.message.includes('Invalid login credentials')) {
                    showToast('Email ou senha incorretos', 'error');
                } else {
                    showToast('Erro ao conectar ao servidor: ' + error.message, 'error');
                }
                return null;
            }
            
            if (!session) {
                hideLoader();
                showToast('Erro na autentica√ß√£o', 'error');
                return null;
            }
            
            // Obter informa√ß√µes do usu√°rio
            const user = session.user;
            console.log('Usu√°rio autenticado no Nhost:', user.id);
            
            // Buscar dados adicionais do usu√°rio da tabela 'users'
            const userData = await getUserDataFromDatabase(user.id);
            
            // Se n√£o existir na tabela users, criar um registro
            if (!userData) {
                await createUserInDatabase(user);
            }
            
            const finalUserData = {
                id: user.id,
                email: user.email,
                companyName: user.displayName || 'Minha Empresa',
                document: userData?.document || '',
                phone: userData?.phone || '',
                createdAt: user.createdAt || new Date().toISOString(),
                plan: userData?.plan || 'professional',
                status: userData?.status || 'active',
                validUntil: userData?.valid_until || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                isTrial: userData?.is_trial !== false
            };
            
            hideLoader();
            return finalUserData;
            
        } catch (error) {
            console.error('Erro no login:', error);
            hideLoader();
            showToast('Erro ao fazer login: ' + error.message, 'error');
            return null;
        }
    }

    async function getUserDataFromDatabase(userId) {
        try {
            if (!nhost) return null;

            const { data, error } = await nhost.graphql.request(`
                query GetUserData($userId: uuid!) {
                    users_by_pk(id: $userId) {
                        id
                        document
                        phone
                        company_name
                        plan
                        status
                        valid_until
                        is_trial
                        created_at
                    }
                }
            `, {
                userId
            });

            if (error) {
                console.error('Erro ao buscar dados do usu√°rio:', error);
                return null;
            }

            return data?.users_by_pk;
        } catch (error) {
            console.error('Erro em getUserDataFromDatabase:', error);
            return null;
        }
    }

    async function createUserInDatabase(nhostUser) {
        try {
            if (!nhost) return null;

            const trialEnd = new Date();
            trialEnd.setDate(trialEnd.getDate() + TRIAL_DAYS);

            const { data, error } = await nhost.graphql.request(`
                mutation CreateUser($userId: uuid!, $email: String!, $companyName: String!) {
                    insert_users_one(object: {
                        id: $userId,
                        email: $email,
                        company_name: $companyName,
                        document: "",
                        phone: "",
                        plan: "professional",
                        status: "active",
                        valid_until: "${trialEnd.toISOString()}",
                        is_trial: true
                    }) {
                        id
                    }
                }
            `, {
                userId: nhostUser.id,
                email: nhostUser.email,
                companyName: nhostUser.displayName || 'Minha Empresa'
            });

            if (error) {
                console.error('Erro ao criar usu√°rio no banco:', error);
                return null;
            }

            return data?.insert_users_one;
        } catch (error) {
            console.error('Erro em createUserInDatabase:', error);
            return null;
        }
    }

    async function nhostRegister(userData) {
        showLoader();
        
        try {
            if (!nhost) {
                throw new Error('Nhost n√£o inicializado');
            }

            // Registrar no Nhost Auth
            const { session, error: signUpError } = await nhost.auth.signUp({
                email: userData.email,
                password: userData.password,
                options: {
                    displayName: userData.companyName || 'Minha Empresa'
                }
            });
            
            if (signUpError) {
                console.error('Erro no registro Nhost:', signUpError);
                hideLoader();
                
                if (signUpError.message.includes('already registered')) {
                    showToast('Este email j√° est√° cadastrado', 'error');
                } else {
                    showToast('Erro ao criar conta: ' + signUpError.message, 'error');
                }
                return null;
            }
            
            if (!session) {
                hideLoader();
                showToast('Erro ao criar conta', 'error');
                return null;
            }
            
            const user = session.user;
            console.log('Usu√°rio registrado no Nhost:', user.id);
            
            // Criar registro na tabela users
            await createUserInDatabaseWithDetails(user, userData);
            
            // Criar produtos padr√£o para este usu√°rio
            await createDefaultProducts(user.id);
            
            hideLoader();
            
            // Retornar dados do usu√°rio
            return {
                id: user.id,
                email: user.email,
                companyName: userData.companyName || 'Minha Empresa',
                document: userData.document || '',
                phone: userData.phone || '',
                createdAt: new Date().toISOString(),
                plan: 'professional',
                status: 'active',
                validUntil: new Date(Date.now() + TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
                isTrial: true
            };
            
        } catch (error) {
            console.error('Erro no registro:', error);
            hideLoader();
            showToast('Erro ao criar conta: ' + error.message, 'error');
            return null;
        }
    }

    async function createUserInDatabaseWithDetails(nhostUser, userData) {
        try {
            if (!nhost) return null;

            const trialEnd = new Date();
            trialEnd.setDate(trialEnd.getDate() + TRIAL_DAYS);

            const { data, error } = await nhost.graphql.request(`
                mutation CreateUserWithDetails(
                    $userId: uuid!, 
                    $email: String!, 
                    $companyName: String!,
                    $document: String!,
                    $phone: String!
                ) {
                    insert_users_one(object: {
                        id: $userId,
                        email: $email,
                        company_name: $companyName,
                        document: $document,
                        phone: $phone,
                        plan: "professional",
                        status: "active",
                        valid_until: "${trialEnd.toISOString()}",
                        is_trial: true
                    }) {
                        id
                    }
                }
            `, {
                userId: nhostUser.id,
                email: nhostUser.email,
                companyName: userData.companyName || 'Minha Empresa',
                document: userData.document || '',
                phone: userData.phone || ''
            });

            if (error) {
                console.error('Erro ao criar usu√°rio com detalhes:', error);
                return null;
            }

            return data?.insert_users_one;
        } catch (error) {
            console.error('Erro em createUserInDatabaseWithDetails:', error);
            return null;
        }
    }

    async function createDefaultProducts(userId) {
        try {
            if (!nhost || !userId) return;
            
            // Preparar produtos para inser√ß√£o
            const productsToInsert = defaultProducts.map(product => ({
                user_id: userId,
                name: product.name,
                price: product.price,
                stock: product.stock,
                emoji: product.emoji,
                category: product.category
            }));
            
            // Inserir produtos em lote
            for (const product of productsToInsert) {
                const { error } = await nhost.graphql.request(`
                    mutation InsertProduct(
                        $userId: uuid!,
                        $name: String!,
                        $price: numeric!,
                        $stock: Int!,
                        $emoji: String!,
                        $category: String!
                    ) {
                        insert_products_one(object: {
                            user_id: $userId,
                            name: $name,
                            price: $price,
                            stock: $stock,
                            emoji: $emoji,
                            category: $category
                        }) {
                            id
                        }
                    }
                `, product);
                
                if (error) {
                    console.error('Erro ao criar produto padr√£o:', error);
                }
            }
            
            console.log('Produtos padr√£o criados para usu√°rio:', userId);
        } catch (error) {
            console.error('Erro em createDefaultProducts:', error);
        }
    }

    async function loadUserProducts(userId) {
        try {
            if (!nhost || !userId) {
                console.log('Usando produtos locais');
                return defaultProducts;
            }

            const { data, error } = await nhost.graphql.request(`
                query GetUserProducts($userId: uuid!) {
                    products(where: {user_id: {_eq: $userId}}) {
                        id
                        name
                        price
                        stock
                        emoji
                        category
                        created_at
                    }
                }
            `, {
                userId
            });
            
            if (error) {
                console.error('Erro ao carregar produtos:', error);
                return defaultProducts;
            }
            
            if (!data?.products || data.products.length === 0) {
                await createDefaultProducts(userId);
                return defaultProducts;
            }
            
            // Transformar dados
            return data.products.map((p, index) => ({
                id: p.id,
                name: p.name,
                price: parseFloat(p.price),
                stock: p.stock,
                emoji: p.emoji || 'üì¶',
                category: p.category,
                _nhostId: p.id
            }));
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
            return defaultProducts;
        }
    }

    async function saveProductToNhost(product, userId) {
        try {
            if (!nhost || !userId) return null;

            if (product._nhostId) {
                // Atualizar produto existente
                const { data, error } = await nhost.graphql.request(`
                    mutation UpdateProduct(
                        $productId: uuid!,
                        $name: String!,
                        $price: numeric!,
                        $stock: Int!,
                        $emoji: String!,
                        $category: String!
                    ) {
                        update_products_by_pk(
                            pk_columns: {id: $productId},
                            _set: {
                                name: $name,
                                price: $price,
                                stock: $stock,
                                emoji: $emoji,
                                category: $category
                            }
                        ) {
                            id
                        }
                    }
                `, {
                    productId: product._nhostId,
                    name: product.name,
                    price: product.price,
                    stock: product.stock,
                    emoji: product.emoji,
                    category: product.category
                });
                
                if (error) throw error;
                return data?.update_products_by_pk?.id;
            } else {
                // Inserir novo produto
                const { data, error } = await nhost.graphql.request(`
                    mutation InsertProduct(
                        $userId: uuid!,
                        $name: String!,
                        $price: numeric!,
                        $stock: Int!,
                        $emoji: String!,
                        $category: String!
                    ) {
                        insert_products_one(object: {
                            user_id: $userId,
                            name: $name,
                            price: $price,
                            stock: $stock,
                            emoji: $emoji,
                            category: $category
                        }) {
                            id
                        }
                    }
                `, {
                    userId: userId,
                    name: product.name,
                    price: product.price,
                    stock: product.stock,
                    emoji: product.emoji,
                    category: product.category
                });
                
                if (error) throw error;
                return data?.insert_products_one?.id;
            }
        } catch (error) {
            console.error('Erro ao salvar produto no Nhost:', error);
            throw error;
        }
    }

    async function recordSaleToNhost(saleData, userId) {
        try {
            if (!nhost || !userId) {
                console.log('Nhost n√£o dispon√≠vel, venda registrada apenas localmente');
                return false;
            }

            console.log('Registrando venda no Nhost:', saleData.id);
            
            // 1. Registrar a venda
            const { data: sale, error: saleError } = await nhost.graphql.request(`
                mutation RecordSale(
                    $saleId: String!,
                    $userId: uuid!,
                    $saleDate: timestamptz!,
                    $subtotal: numeric!,
                    $discount: numeric!,
                    $total: numeric!,
                    $itemsCount: Int!,
                    $paymentMethod: String!,
                    $processingTime: numeric!
                ) {
                    insert_sales_one(object: {
                        id: $saleId,
                        user_id: $userId,
                        sale_date: $saleDate,
                        subtotal: $subtotal,
                        discount: $discount,
                        total: $total,
                        items_count: $itemsCount,
                        payment_method: $paymentMethod,
                        processing_time: $processingTime
                    }) {
                        id
                    }
                }
            `, {
                saleId: saleData.id,
                userId: userId,
                saleDate: new Date().toISOString(),
                subtotal: saleData.subtotal,
                discount: saleData.discount,
                total: saleData.total,
                itemsCount: saleData.itemsCount,
                paymentMethod: saleData.method,
                processingTime: saleData.processingTime
            });
            
            if (saleError) {
                console.error('Erro ao registrar venda:', saleError);
                throw saleError;
            }
            
            console.log('Venda registrada:', sale?.insert_sales_one?.id);
            return true;
        } catch (error) {
            console.error('Erro ao registrar venda no Nhost:', error);
            throw error;
        }
    }

    async function loadSalesHistoryFromNhost(userId, filter = 'all') {
        try {
            if (!nhost || !userId) {
                console.log('Nhost n√£o dispon√≠vel, usando hist√≥rico local');
                return [];
            }

            console.log('Carregando hist√≥rico para usu√°rio:', userId, 'filtro:', filter);
            
            let whereClause = `user_id: {_eq: "${userId}"}`;
            
            // Aplicar filtro de data
            if (filter !== 'all') {
                const now = new Date();
                let startDate = new Date();
                
                if (filter === 'today') {
                    startDate.setHours(0, 0, 0, 0);
                } else if (filter === 'week') {
                    startDate.setDate(now.getDate() - 7);
                } else if (filter === 'month') {
                    startDate.setMonth(now.getMonth() - 1);
                }
                
                whereClause += `, sale_date: {_gte: "${startDate.toISOString()}"}`;
            }
            
            const { data, error } = await nhost.graphql.request(`
                query GetSalesHistory($userId: uuid!) {
                    sales(
                        where: {${whereClause}},
                        order_by: {sale_date: desc}
                    ) {
                        id
                        sale_date
                        subtotal
                        discount
                        total
                        items_count
                        payment_method
                        processing_time
                    }
                }
            `, {
                userId
            });
            
            if (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                return [];
            }
            
            console.log('Hist√≥rico carregado:', data?.sales?.length || 0, 'vendas');
            
            // Formatar os dados para compatibilidade
            return (data?.sales || []).map(sale => ({
                id: sale.id,
                date: new Date(sale.sale_date).toLocaleString('pt-BR'),
                timestamp: new Date(sale.sale_date).getTime(),
                subtotal: parseFloat(sale.subtotal),
                discount: parseFloat(sale.discount),
                total: parseFloat(sale.total),
                itemsCount: sale.items_count,
                method: sale.payment_method,
                processingTime: parseFloat(sale.processing_time) || 0
            }));
        } catch (error) {
            console.error('Erro ao carregar hist√≥rico:', error);
            return [];
        }
    }

    async function deleteProductFromNhost(productId, userId) {
        try {
            if (!nhost || !userId) return false;

            console.log('Excluindo produto do Nhost:', productId);
            
            const { error } = await nhost.graphql.request(`
                mutation DeleteProduct($productId: uuid!, $userId: uuid!) {
                    delete_products(
                        where: {id: {_eq: $productId}, user_id: {_eq: $userId}}
                    ) {
                        affected_rows
                    }
                }
            `, {
                productId,
                userId
            });
            
            if (error) throw error;
            
            console.log('Produto exclu√≠do do Nhost:', productId);
            return true;
        } catch (error) {
            console.error('Erro ao excluir produto:', error);
            throw error;
        }
    }

    // --- FUN√á√ïES DE AUTENTICA√á√ÉO CORRIGIDAS ---

    function showLogin() {
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('registerCard').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('registerCard').style.display = 'block';
    }

    async function loginUser(email, password) {
        if (!email || !password) {
            showToast('Preencha email e senha', 'error');
            return;
        }

        const user = await nhostLogin(email, password);
        
        if (user) {
            currentUser = user;
            isAuthenticated = true;
            
            console.log('Usu√°rio autenticado:', user.companyName);
            
            // Carregar dados do usu√°rio
            products = await loadUserProducts(user.id);
            salesHistory = await loadSalesHistoryFromNhost(user.id);
            
            // Mostrar aplica√ß√£o
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'grid';
            
            // Salvar sess√£o
            localStorage.setItem('pdv_current_user', JSON.stringify(user));
            
            // Inicializar app
            initApp();
            
            showToast(`Bem-vindo, ${user.companyName}! üëã`, 'success');
        }
    }

    async function registerUser(userData) {
        // Valida√ß√µes b√°sicas
        if (!userData.email || !userData.password || !userData.confirmPassword) {
            showToast('Preencha todos os campos', 'error');
            return;
        }
        
        if (userData.password !== userData.confirmPassword) {
            showToast('As senhas n√£o coincidem', 'error');
            return;
        }
        
        if (userData.password.length < 6) {
            showToast('A senha deve ter pelo menos 6 caracteres', 'error');
            return;
        }
        
        const newUser = await nhostRegister(userData);
        
        if (newUser) {
            showToast('Conta criada com sucesso! üéâ', 'success');
            
            // Fazer login automaticamente
            currentUser = newUser;
            isAuthenticated = true;
            products = await loadUserProducts(newUser.id);
            salesHistory = [];
            
            // Salvar sess√£o
            localStorage.setItem('pdv_current_user', JSON.stringify(newUser));
            
            // Mostrar aplica√ß√£o
            setTimeout(() => {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'grid';
                initApp();
                showToast(`Bem-vindo, ${newUser.companyName}! üöÄ`, 'success');
            }, 1000);
        }
    }

    function updateSubscriptionStatus() {
        if (!currentUser) return;
        
        const statusEl = document.getElementById('subscriptionStatus');
        const now = new Date();
        const validUntil = new Date(currentUser.validUntil);
        const daysLeft = Math.ceil((validUntil - now) / (1000 * 60 * 60 * 24));
        
        if (currentUser.isTrial) {
            statusEl.innerHTML = `<i class="fas fa-star"></i> <span>Trial: ${daysLeft} dias restantes</span>`;
            statusEl.style.background = 'var(--warning)';
            
            if (daysLeft <= 3) {
                statusEl.style.background = 'var(--danger)';
                showToast(`Seu trial termina em ${daysLeft} dias. Atualize seu plano!`, 'warning');
            }
        } else {
            statusEl.innerHTML = `<i class="fas fa-crown"></i> <span>Plano Ativo</span>`;
            statusEl.style.background = 'var(--success)';
        }
    }

    function openAccountModal() {
        if (!currentUser) return;
        
        // Preencher dados da conta
        document.getElementById('accountCompanyName').textContent = currentUser.companyName;
        document.getElementById('accountEmail').textContent = currentUser.email;
        document.getElementById('accountDocument').textContent = currentUser.document || 'N√£o informado';
        document.getElementById('accountPhone').textContent = currentUser.phone || 'N√£o informado';
        
        const createdAt = new Date(currentUser.createdAt);
        document.getElementById('accountCreatedAt').textContent = createdAt.toLocaleDateString('pt-BR');
        
        const validUntil = new Date(currentUser.validUntil);
        document.getElementById('accountValidUntil').textContent = validUntil.toLocaleDateString('pt-BR');
        
        document.getElementById('accountNextBilling').textContent = `R$ ${MONTHLY_PRICE.toFixed(2)} em ${validUntil.toLocaleDateString('pt-BR')}`;
        
        document.getElementById('accountPlanStatus').textContent = currentUser.isTrial ? 'TRIAL' : 'PROFISSIONAL';
        
        // Mostrar modal
        document.getElementById('accountModal').style.display = 'flex';
    }

    function upgradePlan() {
        showToast('Redirecionando para p√°gina de pagamento...', 'info');
        setTimeout(() => {
            document.getElementById('accountModal').style.display = 'none';
            showToast('P√°gina de pagamento em desenvolvimento. Em produ√ß√£o, isso redirecionaria para o gateway.', 'warning');
        }, 1000);
    }

    async function logout() {
        if (confirm('Tem certeza que deseja sair do sistema?')) {
            try {
                // Deslogar do Nhost
                await nhost.auth.signOut();
            } catch (error) {
                console.error('Erro ao deslogar do Nhost:', error);
            }
            
            // Resetar estado
            currentUser = null;
            isAuthenticated = false;
            cart = [];
            products = [...defaultProducts];
            salesHistory = [];
            
            // Remover sess√£o salva
            localStorage.removeItem('pdv_current_user');
            
            // Mostrar tela de login
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginCard').style.display = 'block';
            document.getElementById('registerCard').style.display = 'none';
            
            showToast('Voc√™ saiu do sistema. At√© logo! üëã', 'info');
        }
    }

    // --- INICIALIZA√á√ÉO DO SISTEMA ---
    async function init() {
        console.log(`${APP_NAME} v${APP_VERSION} inicializando...`);
        
        // Verificar se h√° usu√°rio salvo
        const savedUser = localStorage.getItem('pdv_current_user');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                isAuthenticated = true;
                
                // Verificar se a sess√£o do Nhost ainda √© v√°lida
                const isSignedIn = await nhost.auth.isSignedIn();
                
                if (isSignedIn) {
                    // Carregar aplica√ß√£o direto
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'grid';
                    
                    // Carregar dados atualizados
                    products = await loadUserProducts(currentUser.id);
                    salesHistory = await loadSalesHistoryFromNhost(currentUser.id);
                    
                    initApp();
                    showToast(`Bem-vindo de volta, ${currentUser.companyName}!`, 'success');
                    return;
                } else {
                    // Sess√£o expirou, fazer login novamente
                    localStorage.removeItem('pdv_current_user');
                }
            } catch (e) {
                console.error('Erro ao carregar usu√°rio salvo:', e);
                localStorage.removeItem('pdv_current_user');
            }
        }
        
        // Mostrar tela de login
        document.getElementById('authContainer').style.display = 'flex';
        
        // Configurar formul√°rios
        setupAuthForms();
        
        // Criar part√≠culas m√°gicas
        createMagicParticles();
    }

    function setupAuthForms() {
        // Formul√°rio de login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            loginUser(email, password);
        });
        
        // Formul√°rio de cadastro
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const companyName = document.getElementById('regCompany').value.trim() || 'Minha Empresa';
            const documentNum = document.getElementById('regDocument').value.trim() || '00.000.000/0000-00';
            const phone = document.getElementById('regPhone').value.trim() || '(11) 99999-9999';
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const terms = document.getElementById('regTerms').checked;
            
            if (!email || !password || !confirmPassword) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            if (!terms) {
                showToast('Voc√™ deve aceitar os termos de uso', 'error');
                return;
            }
            
            registerUser({
                companyName,
                document: documentNum,
                phone,
                email,
                password,
                confirmPassword
            });
        });
    }

    function initApp() {
        console.log(`Aplica√ß√£o inicializada para: ${currentUser.companyName}`);
        
        // Mostrar loader
        showLoader();
        
        // Inicializar componentes
        setTimeout(() => {
            populateEmojiList();
            renderAll();
            setupBarcodeScanner();
            setupKeyboardShortcuts();
            updateNotifications();
            updateLiveStats();
            updateSubscriptionStatus();
            
            // Esconder loader ap√≥s 1.5 segundos
            setTimeout(() => {
                hideLoader();
                showToast(`Sistema ${APP_NAME} carregado com sucesso! ‚ú®`, 'success');
            }, 800);
        }, 500);
        
        // Configurar auto-save
        setInterval(saveData, 30000);
        
        // Atualizar estat√≠sticas em tempo real
        setInterval(updateLiveStats, 5000);
        
        // Verificar estoque baixo periodicamente
        setInterval(checkLowStock, 10000);
        
        // Verificar status da assinatura periodicamente
        setInterval(checkSubscription, 60000);
    }

    function checkSubscription() {
        if (!currentUser) return;
        
        const now = new Date();
        const validUntil = new Date(currentUser.validUntil);
        
        if (now > validUntil) {
            showToast('Sua assinatura expirou. Renove para continuar usando o sistema.', 'error', 10000);
            updateSubscriptionStatus();
        }
    }

    // ... (todas as outras fun√ß√µes permanecem exatamente as mesmas) ...

    // --- SISTEMA DE PAGAMENTO AVAN√áADO ---
    function openPaymentModal() {
        if(cart.length === 0) {
            showToast('Adicione produtos ao carrinho antes de finalizar a venda', 'warning');
            return;
        }
        
        // Calcular totais
        const subtotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
        const discountAmount = subtotal * (currentDiscount / 100);
        const total = subtotal - discountAmount;
        
        // Atualizar valores no modal
        document.getElementById('modalSubtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
        document.getElementById('modalDiscount').textContent = `-R$ ${discountAmount.toFixed(2)}`;
        document.getElementById('modalTotalValue').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('modalTotalWithDiscount').textContent = `R$ ${total.toFixed(2)}`;
        
        // Mostrar modal
        document.getElementById('paymentModal').style.display = 'flex';
        
        // Registrar tempo de processamento
        stats.processingTime = getSaleProcessingTime();
    }

    async function processPayment(method) {
        // Calcular totais
        let subtotal = 0;
        cart.forEach(item => {
            const product = products.find(p => p.id === item.id);
            if (product) {
                product.stock -= item.qty;
                subtotal += (item.price * item.qty);
                
                // Atualizar estoque no Nhost
                if (currentUser && nhost && product._nhostId) {
                    updateProductStockInNhost(product._nhostId, product.stock, currentUser.id);
                }
            }
        });
        
        const discountAmount = subtotal * (currentDiscount / 100);
        const total = subtotal - discountAmount;
        
        // Aplicar desconto adicional para Pix
        let finalTotal = total;
        let paymentMethod = method;
        if (method === 'Pix') {
            finalTotal = total * 0.95; // 5% de desconto no Pix
            paymentMethod = 'Pix (5% OFF)';
        }
        
        // Criar registro da venda
        const saleRecord = {
            id: 'V' + Date.now().toString().slice(-6),
            date: new Date().toLocaleString('pt-BR'),
            timestamp: Date.now(),
            subtotal: subtotal,
            discount: discountAmount,
            total: finalTotal,
            itemsCount: cart.reduce((acc, item) => acc + item.qty, 0),
            items: JSON.parse(JSON.stringify(cart)),
            method: paymentMethod,
            processingTime: stats.processingTime
        };
        
        // Registrar venda no Nhost
        try {
            if (currentUser && nhost) {
                await recordSaleToNhost(saleRecord, currentUser.id);
                showToast(`Venda registrada no servidor! ‚úÖ`, 'success');
            }
        } catch (error) {
            console.error('Erro ao registrar venda no Nhost:', error);
            showToast('Venda registrada localmente, mas houve erro no servidor', 'warning');
        }
        
        // Adicionar ao hist√≥rico local
        salesHistory.unshift(saleRecord);
        currentSaleData = saleRecord;
        
        // Resetar carrinho
        cart = [];
        currentDiscount = 0;
        updateCartUI();
        saveData();
        closePaymentModal();
        
        // Mostrar confirma√ß√£o
        showToast(`Venda #${saleRecord.id} finalizada via ${paymentMethod}! üéâ`, 'success');
        
        // Atualizar dashboard
        updateDashboard();
        
        // Abrir modal de recibo ap√≥s um breve delay
        setTimeout(() => {
            openReceiptModal();
        }, 800);
    }

    async function updateProductStockInNhost(productId, newStock, userId) {
        try {
            if (!nhost || !productId || !userId) return;

            const { error } = await nhost.graphql.request(`
                mutation UpdateProductStock($productId: uuid!, $newStock: Int!, $userId: uuid!) {
                    update_products(
                        where: {id: {_eq: $productId}, user_id: {_eq: $userId}},
                        _set: {stock: $newStock}
                    ) {
                        affected_rows
                    }
                }
            `, {
                productId,
                newStock,
                userId
            });
            
            if (error) {
                console.error('Erro ao atualizar estoque no Nhost:', error);
            }
        } catch (error) {
            console.error('Erro em updateProductStockInNhost:', error);
        }
    }

    async function addProduct() {
        const name = document.getElementById('newProdName').value.trim();
        const price = parseFloat(document.getElementById('newProdPrice').value);
        const stock = parseInt(document.getElementById('newProdStock').value);
        const emojiVal = document.getElementById('newProdEmoji').value.trim();
        const category = document.getElementById('newProdCategory').value;
        
        // Validar
        if (!name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
            showToast('Preencha todos os campos corretamente', 'error');
            return;
        }
        
        // Extrair emoji
        let emoji = 'üì¶';
        if (emojiVal) {
            const emojiRegex = /[\p{Emoji_Presentation}\p{Emoji}\uFE0F]/u;
            if (emojiRegex.test(emojiVal.charAt(0))) {
                emoji = emojiVal.charAt(0);
            } else {
                const found = emojiDB.find(item => item.keys.includes(emojiVal.toLowerCase()));
                emoji = found ? found.char : 'üì¶';
            }
        }
        
        // Criar novo produto local
        const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        const newProduct = { 
            id: newId, 
            name, 
            price, 
            stock, 
            emoji, 
            category: category || 'outro'
        };
        
        // Salvar no Nhost se houver usu√°rio logado
        if (currentUser && nhost) {
            try {
                const nhostId = await saveProductToNhost(newProduct, currentUser.id);
                newProduct._nhostId = nhostId;
                console.log('Produto salvo no Nhost com ID:', nhostId);
            } catch (error) {
                console.error('Erro ao salvar produto no Nhost:', error);
                showToast('Produto salvo localmente, mas erro no servidor', 'warning');
            }
        }
        
        // Adicionar localmente
        products.push(newProduct);
        
        // Limpar formul√°rio
        document.getElementById('newProdName').value = '';
        document.getElementById('newProdPrice').value = '';
        document.getElementById('newProdStock').value = '';
        document.getElementById('newProdEmoji').value = '';
        document.getElementById('newProdCategory').value = '';
        document.getElementById('emojiPreview').textContent = 'üì¶';
        
        showToast(`Produto "${name}" adicionado com sucesso!`, 'success');
        
        // Atualizar badge de estoque baixo
        checkLowStock();
        
        // Atualizar UI
        renderStock();
        renderPOS();
    }

    async function updateStock(id, newQty) {
        const p = products.find(p => p.id === id);
        if (!p) return;
        
        const oldQty = p.stock;
        p.stock = parseInt(newQty) || 0;
        
        // Atualizar no Nhost se houver usu√°rio logado
        if (currentUser && nhost && p._nhostId) {
            try {
                await saveProductToNhost(p, currentUser.id);
                console.log('Estoque atualizado no Nhost:', p._nhostId, 'novo estoque:', p.stock);
            } catch (error) {
                console.error('Erro ao atualizar estoque no Nhost:', error);
            }
        }
        
        // Notificar se estoque ficou baixo
        if (oldQty >= 5 && p.stock < 5) {
            showToast(`Aten√ß√£o: Estoque baixo de ${p.name} (${p.stock} unidades)`, 'warning');
        }
        
        // Atualizar badge de estoque baixo
        checkLowStock();
        
        // Atualizar UI
        renderStock();
        renderPOS();
    }

    async function deleteProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        if (confirm(`Tem certeza que deseja excluir o produto "${product.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
            // Verificar se o produto est√° no carrinho
            const inCart = cart.find(item => item.id === id);
            if (inCart) {
                if (!confirm('Este produto est√° no carrinho de vendas atual. Excluir mesmo assim?')) {
                    return;
                }
                // Remover do carrinho tamb√©m
                cart = cart.filter(item => item.id !== id);
                updateCartUI();
            }
            
            // Excluir do Nhost se houver usu√°rio logado
            if (currentUser && nhost && product._nhostId) {
                try {
                    await deleteProductFromNhost(product._nhostId, currentUser.id);
                    console.log('Produto exclu√≠do do Nhost:', product._nhostId);
                } catch (error) {
                    console.error('Erro ao excluir produto do Nhost:', error);
                    showToast('Produto exclu√≠do localmente, mas erro no servidor', 'warning');
                }
            }
            
            // Excluir localmente
            products = products.filter(p => p.id !== id);
            showToast(`Produto "${product.name}" exclu√≠do com sucesso`, 'info');
            
            // Atualizar badge de estoque baixo
            checkLowStock();
            
            // Atualizar UI
            renderStock();
            renderPOS();
        }
    }

    async function saveProductEdit(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        // Atualizar dados localmente
        product.name = document.getElementById('newProdName').value.trim();
        product.price = parseFloat(document.getElementById('newProdPrice').value);
        product.stock = parseInt(document.getElementById('newProdStock').value);
        product.category = document.getElementById('newProdCategory').value || 'outro';
        
        const emojiVal = document.getElementById('newProdEmoji').value.trim();
        if (emojiVal) {
            const emojiRegex = /[\p{Emoji_Presentation}\p{Emoji}\uFE0F]/u;
            product.emoji = emojiRegex.test(emojiVal.charAt(0)) ? emojiVal.charAt(0) : product.emoji;
        }
        
        // Salvar no Nhost se houver usu√°rio logado
        if (currentUser && nhost && product._nhostId) {
            try {
                await saveProductToNhost(product, currentUser.id);
                console.log('Produto atualizado no Nhost:', product._nhostId);
            } catch (error) {
                console.error('Erro ao atualizar produto no Nhost:', error);
                showToast('Produto atualizado localmente, mas erro no servidor', 'warning');
            }
        }
        
        cancelEdit('<i class="fas fa-plus-circle"></i> Adicionar');
        showToast(`Produto "${product.name}" atualizado com sucesso!`, 'success');
        
        // Atualizar UI
        renderStock();
        renderPOS();
    }

    // --- DASHBOARD ANAL√çTICO ---
    async function updateDashboard() {
        // Carregar hist√≥rico atualizado do Nhost
        if (currentUser) {
            salesHistory = await loadSalesHistoryFromNhost(currentUser.id, 'all');
            renderDashboardData();
        } else {
            renderDashboardData();
        }
    }

    // ... (todas as outras fun√ß√µes permanecem exatamente as mesmas) ...

    // --- INICIALIZAR SISTEMA ---
    init();
    
    // Expor fun√ß√µes globais para o HTML
    window.switchTab = switchTab;
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.updateCartItemQuantity = updateCartItemQuantity;
    window.clearCart = clearCart;
    window.openPaymentModal = openPaymentModal;
    window.closePaymentModal = closePaymentModal;
    window.processPayment = processPayment;
    window.applyDiscount = applyDiscount;
    window.applyDiscountToSale = applyDiscountToSale;
    window.openReceiptModal = openReceiptModal;
    window.closeReceiptModal = closeReceiptModal;
    window.printReceiptFromModal = printReceiptFromModal;
    window.sendViaWhatsapp = sendViaWhatsapp;
    window.sendViaEmail = sendViaEmail;
    window.addProduct = addProduct;
    window.updateStock = updateStock;
    window.deleteProduct = deleteProduct;
    window.editProduct = editProduct;
    window.saveProductEdit = saveProductEdit;
    window.filterStockTable = filterStockTable;
    window.exportStockCSV = exportStockCSV;
    window.filterSalesHistory = filterSalesHistory;
    window.exportSalesCSV = exportSalesCSV;
    window.generateSalesChart = generateSalesChart;
    window.viewSaleDetails = viewSaleDetails;
    window.openVoiceSearch = openVoiceSearch;
    window.openQuickProductModal = openQuickProductModal;
    window.closeQuickProductModal = closeQuickProductModal;
    window.addQuickProduct = addQuickProduct;
    window.quickSale = quickSale;
    window.toggleDarkMode = toggleDarkMode;
    window.selectSuggestion = selectSuggestion;
    window.filterEmojiList = filterEmojiList;
    window.suggestEmoji = suggestEmoji;
    window.openSplitPaymentModal = openSplitPaymentModal;
    window.showLogin = showLogin;
    window.showRegister = showRegister;
    window.openAccountModal = openAccountModal;
    window.upgradePlan = upgradePlan;
    window.logout = logout;
    window.showTerms = function() {
        alert(`TERMOS DE USO DO PDV M√ÅGICO PRO

1. Per√≠odo de Teste: 7 dias gratuitos
2. Assinatura: R$ 29,90/m√™s ap√≥s o per√≠odo de teste
3. Pagamento: Cobran√ßa autom√°tica mensal
4. Cancelamento: A qualquer momento
5. Dados: Seus dados s√£o armazenados localmente e no Nhost

Para cancelar, entre em contato com nosso suporte.`);
    };

    // Log de inicializa√ß√£o
    console.log(`${APP_NAME} v${APP_VERSION} pronto para uso!`);
</script>
</body>
</html>
