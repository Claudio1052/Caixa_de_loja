<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV M√°gico ‚ú® | Supabase Diagnostic</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');

        :root {
            --bg-color: #e0e5ec;
            --glass: rgba(255, 255, 255, 0.85);
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --danger: #ff7675;
            --success: #00b894;
            --text: #2d3436;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }

        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        /* Status Conex√£o */
        .status-bar {
            background: white; padding: 10px 20px; border-radius: 15px; 
            margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .status-indicator { display: flex; align-items: center; gap: 10px; font-weight: 800; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #ccc; }
        .online .dot { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .offline .dot { background: var(--danger); }
        .error-msg { color: var(--danger); font-size: 0.85rem; font-weight: 700; display: none; }

        /* Layout Principal */
        .app-container {
            display: grid; grid-template-columns: 250px 1fr; gap: 20px;
            height: calc(100vh - 100px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--glass); border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .menu-btn {
            padding: 15px; border: none; background: transparent; text-align: left;
            font-weight: 700; color: #636e72; cursor: pointer; border-radius: 12px;
            transition: 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .menu-btn:hover, .menu-btn.active { background: var(--primary); color: white; }

        /* Conte√∫do */
        .main-content {
            background: var(--glass); border-radius: 20px; padding: 20px;
            overflow-y: auto; position: relative;
        }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}

        /* Grid Produtos */
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;
        }
        .product-card {
            background: white; padding: 15px; border-radius: 15px; text-align: center;
            cursor: pointer; transition: 0.3s; border: 2px solid transparent;
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--secondary); }
        .p-emoji { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .p-price { color: var(--primary); font-weight: 900; font-size: 1.1rem; }

        /* Carrinho Lateral (dentro do PDV) */
        .pdv-layout { display: grid; grid-template-columns: 1fr 300px; gap: 20px; height: 100%; }
        .cart-panel { background: white; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; }
        .cart-list { flex: 1; overflow-y: auto; margin: 10px 0; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 10px; width: 100%; font-weight: 800; cursor: pointer;
        }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* Formul√°rios */
        .form-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; flex: 1; }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 400px; text-align: center; }

    </style>
</head>
<body>

    <div class="status-bar">
        <div class="status-indicator" id="statusIndicator">
            <div class="dot"></div>
            <span id="statusText">Verificando conex√£o...</span>
        </div>
        <span id="errorMsg" class="error-msg"></span>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <h2 style="text-align:center; margin-bottom:20px;">‚ú® PDV M√°gico</h2>
            <button class="menu-btn active" onclick="showSection('pdv')"><i class="fas fa-cash-register"></i> Caixa</button>
            <button class="menu-btn" onclick="showSection('estoque')"><i class="fas fa-boxes"></i> Estoque</button>
            <button class="menu-btn" onclick="showSection('historico')"><i class="fas fa-history"></i> Vendas</button>
        </div>

        <div class="main-content">
            
            <div id="pdv" class="section active">
                <div class="pdv-layout">
                    <div>
                        <input type="text" id="searchProd" placeholder="üîç Buscar produto..." onkeyup="renderProducts()" style="width:100%; margin-bottom:15px;">
                        <div class="products-grid" id="productsContainer">
                            </div>
                    </div>
                    
                    <div class="cart-panel">
                        <h3>üõí Cesta</h3>
                        <div class="cart-list" id="cartContainer">
                            <p style="text-align:center; color:#999; margin-top:20px;">Cesta vazia</p>
                        </div>
                        <div style="font-size:1.5rem; font-weight:900; text-align:right; margin-bottom:10px;" id="totalCart">R$ 0,00</div>
                        <button class="btn-primary" onclick="startCheckout()" id="btnCheckout" disabled>Finalizar</button>
                    </div>
                </div>
            </div>

            <div id="estoque" class="section">
                <h3>üì¶ Gerenciar Produtos</h3>
                <div class="form-group">
                    <input type="text" id="nNome" placeholder="Nome">
                    <input type="number" id="nPreco" placeholder="Pre√ßo" step="0.01">
                    <input type="number" id="nEstoque" placeholder="Qtd">
                    <input type="text" id="nEmoji" placeholder="Emoji" style="max-width:60px;">
                    <button class="btn-primary" style="width:auto;" onclick="addProduct()">+</button>
                </div>
                <table>
                    <thead><tr><th>Nome</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="stockTable"></tbody>
                </table>
            </div>

            <div id="historico" class="section">
                <h3>üìú Hist√≥rico de Vendas</h3>
                <button onclick="loadSales()" style="margin-bottom:10px; padding:5px 10px;">Atualizar</button>
                <table>
                    <thead><tr><th>ID</th><th>Data</th><th>Total</th><th>Pagamento</th></tr></thead>
                    <tbody id="salesTable"></tbody>
                </table>
            </div>

        </div>
    </div>

    <div class="modal" id="payModal">
        <div class="modal-box">
            <h2>Total: <span id="payTotal" style="color:var(--primary)">R$ 0,00</span></h2>
            <p>Selecione o m√©todo:</p>
            <div style="display:grid; gap:10px; margin-top:20px;">
                <button class="btn-primary" onclick="finishSale('dinheiro')">üíµ Dinheiro</button>
                <button class="btn-primary" onclick="finishSale('pix')">üí† Pix</button>
                <button class="btn-primary" onclick="finishSale('cartao')">üí≥ Cart√£o</button>
                <button class="btn-primary" style="background:var(--danger);" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONEX√ÉO SUPABASE ---
        // Usando a Anon Key (JWT) que √© o padr√£o para o cliente JS
        const SB_URL = 'https://kbucnveojexlxlnefmdo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtidWNudmVvamV4bHhsbmVmbWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTUzOTgsImV4cCI6MjA4NTI3MTM5OH0.usSiBO518-4rdkvVxq1QAi71hCLTicIurfAu2N0gShs';
        
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        // --- VARI√ÅVEIS ---
        let products = [];
        let cart = [];
        let isOnline = false;

        // --- INICIALIZA√á√ÉO ---
        window.onload = async () => {
            await testConnection();
            if(isOnline) {
                await loadProducts();
            } else {
                // Dados de teste offline
                products = [
                    { id: 999, nome: 'Produto Offline', preco: 10.00, estoque: 100, emoji: '‚ö†Ô∏è' }
                ];
                renderProducts();
                renderStock();
            }
        };

        // --- FUN√á√ÉO DE DIAGN√ìSTICO ---
        async function testConnection() {
            const statusDiv = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const errorMsg = document.getElementById('errorMsg');

            try {
                // Tenta buscar apenas 1 item para testar a tabela
                let { data, error } = await supabase.from('produtos').select('count', { count: 'exact', head: true });

                if (error) throw error;

                isOnline = true;
                statusDiv.className = 'status-indicator online';
                statusText.innerText = 'Online ‚Ä¢ Conectado';
                errorMsg.style.display = 'none';
                console.log("Conex√£o Supabase: SUCESSO");

            } catch (err) {
                console.error("ERRO DE CONEX√ÉO:", err);
                isOnline = false;
                statusDiv.className = 'status-indicator offline';
                statusText.innerText = 'Offline';
                
                // Exibe o erro espec√≠fico na tela para o usu√°rio ver
                errorMsg.style.display = 'block';
                if(err.code === '42P01') {
                    errorMsg.innerText = "ERRO: Tabela 'produtos' n√£o existe. Rode o SQL no Supabase.";
                    alert("Aten√ß√£o: As tabelas do banco de dados n√£o foram encontradas.\n\nPor favor, v√° ao Supabase > SQL Editor e rode o script de cria√ß√£o das tabelas.");
                } else if(err.message === 'Failed to fetch') {
                    errorMsg.innerText = "ERRO: Falha de Rede (Verifique Internet/CORS)";
                } else {
                    errorMsg.innerText = `ERRO: ${err.message}`;
                }
            }
        }

        // --- L√ìGICA DE DADOS ---
        async function loadProducts() {
            let { data, error } = await supabase.from('produtos').select('*').order('nome');
            if(!error && data) {
                products = data;
                renderProducts();
                renderStock();
            }
        }

        async function addProduct() {
            const nome = document.getElementById('nNome').value;
            const preco = parseFloat(document.getElementById('nPreco').value);
            const estoque = parseInt(document.getElementById('nEstoque').value);
            const emoji = document.getElementById('nEmoji').value || 'üì¶';

            if(!nome || isNaN(preco)) return alert("Preencha os dados!");

            if(isOnline) {
                const { data, error } = await supabase
                    .from('produtos')
                    .insert([{ nome, preco, estoque, emoji }])
                    .select();
                
                if(error) {
                    alert("Erro ao salvar: " + error.message);
                } else {
                    await loadProducts(); // Recarrega do banco
                    clearForm();
                }
            } else {
                alert("Voc√™ est√° offline. N√£o √© poss√≠vel cadastrar novos produtos.");
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Excluir?")) return;
            if(isOnline) {
                await supabase.from('produtos').delete().eq('id', id);
                await loadProducts();
            }
        }

        // --- CARRINHO E VENDA ---
        function addToCart(id) {
            const prod = products.find(p => p.id === id);
            const item = cart.find(i => i.id === id);
            
            if(prod.estoque <= 0) return alert("Sem estoque!");

            if(item) {
                if(item.qty < prod.estoque) item.qty++;
            } else {
                cart.push({ ...prod, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartContainer');
            container.innerHTML = '';
            let total = 0;

            cart.forEach((item, idx) => {
                total += item.preco * item.qty;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <span>${item.nome} (${item.qty}x)</span>
                    <span style="font-weight:bold">R$ ${(item.preco * item.qty).toFixed(2)} 
                    <i class="fas fa-trash" style="color:red; cursor:pointer; margin-left:10px;" onclick="removeFromCart(${idx})"></i></span>
                `;
                container.appendChild(div);
            });

            document.getElementById('totalCart').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('btnCheckout').disabled = cart.length === 0;
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
        }

        function startCheckout() {
            const total = cart.reduce((acc, i) => acc + (i.preco * i.qty), 0);
            document.getElementById('payTotal').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('payModal').style.display = 'flex';
        }

        async function finishSale(method) {
            if(!isOnline) return alert("Vendas apenas Online nesta vers√£o de teste.");

            const total = cart.reduce((acc, i) => acc + (i.preco * i.qty), 0);
            const saleId = 'V' + Date.now();

            try {
                // 1. Gravar Venda
                const { error: errVenda } = await supabase.from('vendas').insert({
                    id: saleId,
                    total: total,
                    metodo_pagamento: method,
                    itens_count: cart.reduce((acc, i) => acc + i.qty, 0)
                });
                if(errVenda) throw errVenda;

                // 2. Gravar Itens
                const itensPayload = cart.map(i => ({
                    venda_id: saleId,
                    produto_id: i.id,
                    nome_produto: i.nome,
                    quantidade: i.qty,
                    preco_unitario: i.preco,
                    total_item: i.preco * i.qty
                }));
                const { error: errItens } = await supabase.from('itens_venda').insert(itensPayload);
                if(errItens) throw errItens;

                // 3. Atualizar Estoque (Simples)
                for(let item of cart) {
                    const prod = products.find(p => p.id === item.id);
                    await supabase.from('produtos').update({ estoque: prod.estoque - item.qty }).eq('id', item.id);
                }

                alert("Venda realizada com sucesso! üéâ");
                cart = [];
                closeModal();
                renderCart();
                loadProducts(); // Atualiza estoque visual

            } catch (err) {
                alert("Erro ao processar venda: " + err.message);
                console.error(err);
            }
        }

        // --- UI AUXILIAR ---
        function renderProducts() {
            const grid = document.getElementById('productsContainer');
            const term = document.getElementById('searchProd').value.toLowerCase();
            grid.innerHTML = '';
            
            products.filter(p => p.nome.toLowerCase().includes(term)).forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => addToCart(p.id);
                card.innerHTML = `
                    <span class="p-emoji">${p.emoji}</span>
                    <div><b>${p.nome}</b></div>
                    <div class="p-price">R$ ${p.preco.toFixed(2)}</div>
                    <small>Estoque: ${p.estoque}</small>
                `;
                grid.appendChild(card);
            });
        }

        function renderStock() {
            const tbody = document.getElementById('stockTable');
            tbody.innerHTML = '';
            products.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.emoji} ${p.nome}</td>
                        <td>R$ ${p.preco.toFixed(2)}</td>
                        <td>${p.estoque}</td>
                        <td><button onclick="deleteProduct(${p.id})" style="color:red;border:none;background:none;cursor:pointer;">üóëÔ∏è</button></td>
                    </tr>
                `;
            });
        }

        async function loadSales() {
            if(!isOnline) return;
            const { data } = await supabase.from('vendas').select('*').order('data_hora', {ascending:false}).limit(10);
            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = '';
            if(data) {
                data.forEach(s => {
                    tbody.innerHTML += `<tr>
                        <td>${s.id.slice(0,8)}</td>
                        <td>${new Date(s.data_hora).toLocaleDateString()}</td>
                        <td>R$ ${s.total.toFixed(2)}</td>
                        <td>${s.metodo_pagamento}</td>
                    </tr>`;
                });
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function closeModal() { document.getElementById('payModal').style.display = 'none'; }
        function clearForm() {
            document.getElementById('nNome').value = '';
            document.getElementById('nPreco').value = '';
            document.getElementById('nEstoque').value = '';
        }

    </script>
</body>
</html>
